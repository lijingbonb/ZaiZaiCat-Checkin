name: WPS Checkin

on:
  workflow_dispatch:
  schedule:
    # 每天东京时间 08:10（UTC 23:10）运行
    - cron: "10 23 * * *"

jobs:
  checkin:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (force)
        run: |
         python -m pip install --upgrade pip
         python -m pip install requests pycryptodome
         python -c "import requests; print('requests ok:', requests.__version__)"
         python -c "from Crypto.Cipher import AES; print('crypto ok')"

      - name: Write config/token.json from secret
        run: |
          mkdir -p config
          cat > config/token.json << 'EOF'
          ${{ secrets.WPS_TOKEN_JSON }}
          EOF

      - name: Run WPS checkin
        run: |
          set -o pipefail
          python script/wps/main.py 2>&1 | tee output.log

      - name: Send Telegram message (always)
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          STATUS="${{ job.status }}"
          TITLE="WPS Checkin: ${STATUS}"
          LOG=$(python - << 'PY'
          import pathlib
          p = pathlib.Path("output.log")
          s = p.read_text(errors="ignore") if p.exists() else "(no log)"
          print(s[:3500])
          PY
          )
          TEXT="$TITLE%0A%0A$LOG"
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=${TEXT}" \
            -d "disable_web_page_preview=true" >/dev/null
